(()=>{"use strict";(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=n.querySelector(".error__button"),r=e=>{"Escape"===e.key&&(e.preventDefault(),a())},a=()=>{(e.contains(t)?t:n).remove(),document.removeEventListener("click",a),document.removeEventListener("keydown",r)};window.utils={openErrorOnLoad:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},openSuccessMessage:()=>{window.main.deactivatePage(),e.appendChild(t),document.addEventListener("click",a),document.addEventListener("keydown",r)},openErrorOnUpload:()=>{e.appendChild(n),o.addEventListener("click",a),document.addEventListener("click",a),document.addEventListener("keydown",r)},onPopupEscPress:r}})(),(()=>{const e="POST",t="GET",n=new XMLHttpRequest,o=new XMLHttpRequest,r=(e,t,n)=>{n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t(`Статус ответа: ${n.status} ${n.statusText}`)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=3e3};window.backend={send:(t,o,a)=>{n.open(e,"https://21.javascript.pages.academy/keksobooking"),r(o,a,n),n.send(t)},load:(e,n)=>{o.open(t,"https://21.javascript.pages.academy/keksobooking/data"),r(e,n,o),o.send()}}})(),window.backend.load((e=>{window.data=e.filter((e=>e.offer))}),window.utils.openErrorOnLoad),window.debounce=(e,...t)=>{let n=null;return()=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>{e.apply(null,...t)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),n=e.querySelector("#housing-price"),o=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),a=e.querySelectorAll(".map__checkbox"),i=()=>[...e.querySelectorAll(".map__checkbox:checked")].map((e=>e.value)),d=[e=>t.selectedIndex?e.offer.type===t.value:e,e=>{switch(n.selectedIndex){case 1:return e.offer.price<5e4&&e.offer.price>1e4;case 2:return e.offer.price<1e4;case 3:return e.offer.price>5e4;default:return e}},e=>o.selectedIndex?e.offer.rooms===Number(o.value):e,e=>r.selectedIndex?e.offer.guests===Number(r.value):e,e=>i().length?i().every((t=>e.offer.features.includes(t))):e],c=()=>d.reduce(((e,t)=>e.filter(t)),window.data),s=window.debounce((()=>{window.pin.remove(),window.map.closePopupCard(),window.pin.render(c())}));window.filter={data:c,activate:()=>{t.addEventListener("change",s),n.addEventListener("change",s),o.addEventListener("change",s),r.addEventListener("change",s),a.forEach((e=>e.addEventListener("change",s)))},deactivate:()=>{t.removeEventListener("change",s),n.removeEventListener("change",s),o.removeEventListener("change",s),r.removeEventListener("change",s),a.forEach((e=>e.removeEventListener("change",s)))}}})(),(()=>{const e=document.querySelector(".ad-form__field input[type=file]"),t=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__upload input[type=file]"),o=document.querySelector(".ad-form__photo"),r=document.createElement("img");r.style.maxWidth="100%",r.style.height="auto";const a=(e,t)=>{const n=new FileReader,o=e.files[0];n.addEventListener("load",(()=>{t.src=n.result})),n.readAsDataURL(o)};e.addEventListener("change",(()=>{a(e,t)})),o.appendChild(r),n.addEventListener("change",(()=>{a(n,r)})),window.preview={avatar:t,adphoto:r}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),n=e=>{"Escape"===e.key&&(e.preventDefault(),r())},o=()=>{const t=e.querySelector(".popup");t&&t.remove()},r=()=>{o(),window.pin.deactive(),document.removeEventListener("keydown",n)};window.map={openPopupCard:e=>{o(),window.card.render(e),document.addEventListener("keydown",n)},closePopupCard:r,deactivate:()=>{e.classList.add("map--faded"),window.filter.deactivate(),t.reset(),t.classList.add("map__filters--disabled"),[...t.children].forEach((e=>e.setAttribute("disabled","true"))),window.pin.remove(),window.movepin.setMainPinStartCoords(),document.querySelector(".popup")&&r()},activate:()=>{e.classList.remove("map--faded"),window.pin.render(window.data),window.filter.activate()}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t={x:e.style.top,y:e.style.left};window.movepin={dragNDropMainPin:t=>{let n={x:t.clientX,y:t.clientY};const o=t=>{t.preventDefault();const o=n.x-t.clientX,r=n.y-t.clientY;n={x:t.clientX,y:t.clientY};const a=(e,t,n)=>e>t?t+"px":e<n?n+"px":e+"px";e.style.top=a(e.offsetTop-r,546,46),e.style.left=a(e.offsetLeft-o,1169,-31),window.form.setActivatedPinAddress()},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)},setMainPinStartCoords:()=>{e.style.top=t.x,e.style.left=t.y},mainPin:e}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),n=document.querySelector(".map__filters"),o=()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.classList.remove("map__pin--active")))},r=e=>{const n=t.cloneNode(!0),o=n.querySelector("img");return n.style.cssText=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,o.src=e.author.avatar,o.alt=e.offer.title,n};window.pin={render:t=>{const a=document.createDocumentFragment();for(let e=0;e<t.length&&e<5;e++)a.appendChild(r(t[e]));e.appendChild(a),n.classList.remove("map__filters--disabled"),[...n.children].forEach((e=>e.removeAttribute("disabled","true"))),e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((e,t)=>e.addEventListener("click",(()=>{o(),e.classList.add("map__pin--active"),window.map.openPopupCard(t)}))))},remove:()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},deactive:o}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),n=document.querySelector("#card").content.querySelector(".map__card");window.card={render:o=>{const r=(t=>{const{author:{avatar:o},offer:{title:r,address:a,price:i,type:d,rooms:c,guests:s,checkin:l,checkout:u,description:p,features:m,photos:v}}=t,y=n.cloneNode(!0),w=y.querySelector(".popup__avatar"),f=y.querySelector(".popup__title"),_=y.querySelector(".popup__text--address"),h=y.querySelector(".popup__text--price"),E=y.querySelector(".popup__type"),S=y.querySelector(".popup__text--capacity"),L=y.querySelector(".popup__text--time"),q=y.querySelectorAll(".popup__feature"),g=y.querySelector(".popup__features"),b=y.querySelector(".popup__description");w.src=o||w.remove(),f.textContent=r||f.remove(),_.textContent=a||_.remove(),h.textContent=i?i+"₽/ночь":h.remove(),E.textContent=d?e[d]:E.remove(),S.textContent=c&&s?`${c} комнаты для ${s} гостей`:S.remove(),L.textContent=l&&u?`Заезд после ${l}, выезд до ${u}`:L.remove(),t.offer.features.length?[...q].filter((e=>!m.some((t=>e.className.includes("--"+t))))).forEach((e=>g.removeChild(e))):g.remove(),b.textContent=p||b.remove();const x=y.querySelector(".popup__photos"),k=x.querySelector("img");if(x.innerHTML="",v.length)for(let e=0;e<v.length;e++){const t=k.cloneNode(!0);t.src=v[e],x.appendChild(t)}else x.remove();return y})(window.filter.data()[o]);t.insertBefore(r,t.lastElementChild),r.querySelector(".popup__close").addEventListener("click",window.map.closePopupCard)}}})(),(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t=31,n={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},o=window.movepin.mainPin,r=document.querySelector(".ad-form"),a=r.querySelector("#address"),i=r.querySelector("#capacity"),d=r.querySelector("#room_number"),c=r.querySelector(".ad-form__reset"),s=r.querySelector("#title"),l=r.querySelector("#type"),u=r.querySelector("#price"),p=r.querySelector("#timein"),m=r.querySelector("#timeout"),v=e=>{e.preventDefault(),window.backend.send(new FormData(r),window.utils.openSuccessMessage,window.utils.openErrorOnUpload)},y=()=>{window.main.deactivatePage()},w=e=>{_(e.target.value)},f=(e,t)=>{a.value=parseInt(o.style.left,10)+e+", "+(parseInt(o.style.top,10)+t)};a.setAttribute("readonly",!0),f(t,t);const _=e=>{[...i.options].forEach((t=>{t.disabled=!n[e].includes(t.value)})),i.value=e>3?0:e},h=()=>{const e=s.value.length;e<30?s.setCustomValidity("Еще "+(30-e)+" симв."):e>100?s.setCustomValidity("Удалите лишние "+(e-100)+" симв."):s.setCustomValidity(""),s.reportValidity()},E=()=>{u.placeholder=e[l.value],parseInt(u.value,10)<parseInt(u.placeholder,10)?u.setCustomValidity("Минимальная цена для данного типа жилья: "+u.placeholder):u.setCustomValidity(""),u.reportValidity()};window.form={deactivate:()=>{window.preview.avatar.src="img/muffin-grey.svg",window.preview.adphoto.src="",r.classList.add("ad-form--disabled"),r.querySelectorAll("fieldset").forEach((e=>e.setAttribute("disabled","true"))),r.reset(),_(d.value),f(t,t),l.removeEventListener("change",E),u.removeEventListener("input",E),s.removeEventListener("input",h),d.removeEventListener("change",w),r.removeEventListener("submit",v),c.addEventListener("click",y)},activate:()=>{f(t,84),r.classList.remove("ad-form--disabled"),r.querySelectorAll("fieldset").forEach((e=>e.removeAttribute("disabled","true"))),_(d.value),l.addEventListener("change",E),u.addEventListener("input",E),s.addEventListener("input",h),d.addEventListener("change",w),p.addEventListener("change",(()=>{m.value=p.value})),m.addEventListener("change",(()=>{p.value=m.value})),r.addEventListener("submit",v),c.addEventListener("click",y)},setActivatedPinAddress:()=>{f(t,84)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),n=()=>{window.map.deactivate(),window.form.deactivate()};n();const o=()=>{window.map.activate(),window.form.activate()};e.addEventListener("keydown",(e=>{"Enter"===e.key&&t.classList.contains("map--faded")&&o()})),e.addEventListener("mousedown",(e=>{0===e.button&&t.classList.contains("map--faded")&&o(),window.movepin.dragNDropMainPin("mousedown"),e.preventDefault()})),window.main={deactivatePage:n,activatePage:o}})()})();