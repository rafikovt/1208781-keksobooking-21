(()=>{"use strict";(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),n=o.querySelector(".error__button"),r=e=>{"Escape"===e.key&&(e.preventDefault(),a())},a=()=>{(e.contains(t)?t:o).remove(),document.removeEventListener("click",a),document.removeEventListener("keydown",r)};window.utils={openErrorOnLoad:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},openSuccessMessage:()=>{window.main.deactivatePage(),e.appendChild(t),document.addEventListener("click",a),document.addEventListener("keydown",r)},openErrorOnUpload:()=>{e.appendChild(o),n.addEventListener("click",a),document.addEventListener("click",a),document.addEventListener("keydown",r)},onPopupEscPress:r}})(),(()=>{const e="POST",t="GET",o=new XMLHttpRequest,n=new XMLHttpRequest,r=(e,t,o)=>{o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=3e3};window.backend={send:(t,n,a)=>{o.open(e,"https://21.javascript.pages.academy/keksobooking"),r(n,a,o),o.send(t)},load:(e,o)=>{n.open(t,"https://21.javascript.pages.academy/keksobooking/data"),r(e,o,n),n.send()}}})(),window.backend.load((e=>{window.data=e.filter((e=>e.offer))}),window.utils.openErrorOnLoad),window.debounce=(e,...t)=>{let o=null;return()=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e.apply(null,...t)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),n=e.querySelector("#housing-rooms"),r=e.querySelector("#housing-guests"),a=e.querySelectorAll(".map__checkbox"),d=()=>[...e.querySelectorAll(".map__checkbox:checked")].map((e=>e.value)),i=[e=>t.selectedIndex?e.offer.type===t.value:e,e=>{switch(o.selectedIndex){case 1:return e.offer.price<5e4&&e.offer.price>1e4;case 2:return e.offer.price<1e4;case 3:return e.offer.price>5e4;default:return e}},e=>n.selectedIndex?e.offer.rooms===Number(n.value):e,e=>r.selectedIndex?e.offer.guests===Number(r.value):e,e=>d().length?d().every((t=>e.offer.features.includes(t))):e],c=()=>i.reduce(((e,t)=>e.filter(t)),window.data),s=window.debounce((()=>{window.pin.remove(),window.map.closePopupCard(),window.pin.render(c())}));window.filter={data:c,activate:()=>{t.addEventListener("change",s),o.addEventListener("change",s),n.addEventListener("change",s),r.addEventListener("change",s),a.forEach((e=>e.addEventListener("change",s)))},deactivate:()=>{t.removeEventListener("change",s),o.removeEventListener("change",s),n.removeEventListener("change",s),r.removeEventListener("change",s),a.forEach((e=>e.removeEventListener("change",s)))}}})(),(()=>{const e=document.querySelector(".ad-form__field input[type=file]"),t=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form__photo"),r=document.createElement("img");r.style.maxWidth="100%",r.style.height="auto";const a=(e,t)=>{const o=new FileReader,n=e.files[0];o.addEventListener("load",(()=>{t.src=o.result})),o.readAsDataURL(n)};e.addEventListener("change",(()=>{a(e,t)})),n.appendChild(r),o.addEventListener("change",(()=>{a(o,r)})),window.preview={avatar:t,adphoto:r}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),o=e=>{"Escape"===e.key&&(e.preventDefault(),r())},n=()=>{const t=e.querySelector(".popup");t&&t.remove()},r=()=>{n(),window.pin.deactive(),document.removeEventListener("keydown",o)};window.map={openPopupCard:e=>{n(),window.card.render(e),document.addEventListener("keydown",o)},closePopupCard:r,deactivate:()=>{e.classList.add("map--faded"),window.filter.deactivate(),t.reset(),t.classList.add("map__filters--disabled"),[...t.children].forEach((e=>e.setAttribute("disabled","true"))),window.pin.remove(),window.movepin.setMainPinStartCoords(),document.querySelector(".popup")&&r()},activate:()=>{e.classList.remove("map--faded"),window.pin.render(window.data),window.filter.activate()}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t={x:e.style.top,y:e.style.left};window.movepin={dragNDropMainPin:t=>{let o={x:t.clientX,y:t.clientY};const n=t=>{t.preventDefault();const n=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const a=(e,t,o)=>e>t?t+"px":e<o?o+"px":e+"px";e.style.top=a(e.offsetTop-r,546,46),e.style.left=a(e.offsetLeft-n,1169,-31),window.form.setActivatedPinAddress()},r=e=>{e.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",r)},setMainPinStartCoords:()=>{e.style.top=t.x,e.style.left=t.y},mainPin:e}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map__filters"),n=()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.classList.remove("map__pin--active")))},r=e=>{const o=t.cloneNode(!0),n=o.querySelector("img");return o.style.cssText=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,n.src=e.author.avatar,n.alt=e.offer.title,o};window.pin={render:t=>{const a=document.createDocumentFragment();for(let e=0;e<t.length&&e<5;e++)a.appendChild(r(t[e]));e.appendChild(a),o.classList.remove("map__filters--disabled"),[...o.children].forEach((e=>e.removeAttribute("disabled","true"))),e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((e,t)=>e.addEventListener("click",(()=>{n(),e.classList.add("map__pin--active"),window.map.openPopupCard(t)}))))},remove:()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},deactive:n}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card");window.card={render:n=>{const r=(t=>{const{author:{avatar:n},offer:{title:r,address:a,price:d,type:i,rooms:c,guests:s,checkin:l,checkout:u,description:p,features:m,photos:v}}=t,y=o.cloneNode(!0),w=y.querySelector(".popup__avatar"),f=y.querySelector(".popup__title"),_=y.querySelector(".popup__text--address"),h=y.querySelector(".popup__text--price"),E=y.querySelector(".popup__type"),S=y.querySelector(".popup__text--capacity"),L=y.querySelector(".popup__text--time"),q=y.querySelectorAll(".popup__feature"),g=y.querySelector(".popup__features"),b=y.querySelector(".popup__description");w.src=n||w.remove(),f.textContent=r||f.remove(),_.textContent=a||_.remove(),h.textContent=d?d+"₽/ночь":h.remove(),E.textContent=i?e[i]:E.remove(),S.textContent=c&&s?`${c} комнаты для ${s} гостей`:S.remove(),L.textContent=l&&u?`Заезд после ${l}, выезд до ${u}`:L.remove(),t.offer.features.length?[...q].filter((e=>!m.some((t=>e.className.includes("--"+t))))).forEach((e=>g.removeChild(e))):g.remove(),b.textContent=p||b.remove();const x=y.querySelector(".popup__photos"),k=x.querySelector("img");if(x.innerHTML="",v.length)for(let e=0;e<v.length;e++){const t=k.cloneNode(!0);t.src=v[e],x.appendChild(t)}else x.remove();return y})(window.filter.data()[n]);t.insertBefore(r,t.lastElementChild),r.querySelector(".popup__close").addEventListener("click",window.map.closePopupCard)}}})(),(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t=31,o={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},n=window.movepin.mainPin,r=document.querySelector(".ad-form"),a=r.querySelector("#address"),d=r.querySelector("#capacity"),i=r.querySelector("#room_number"),c=r.querySelector(".ad-form__reset"),s=r.querySelector("#title"),l=r.querySelector("#type"),u=r.querySelector("#price"),p=r.querySelector("#timein"),m=r.querySelector("#timeout"),v=e=>{e.preventDefault(),window.backend.send(new FormData(r),window.utils.openSuccessMessage,window.utils.openErrorOnUpload)},y=()=>{window.main.deactivatePage()},w=e=>{_(e.target.value)},f=(e,t)=>{a.value=parseInt(n.style.left,10)+e+", "+(parseInt(n.style.top,10)+t)};a.setAttribute("readonly",!0),f(t,t);const _=e=>{[...d.options].forEach((t=>{t.disabled=!o[e].includes(t.value)})),d.value=e>3?0:e},h=()=>{const e=s.value.length;e<30?s.setCustomValidity("Еще "+(30-e)+" симв."):e>100?s.setCustomValidity("Удалите лишние "+(e-100)+" симв."):s.setCustomValidity(""),s.reportValidity()},E=()=>{u.placeholder=e[l.value],parseInt(u.value,10)<parseInt(u.placeholder,10)?u.setCustomValidity("Минимальная цена для данного типа жилья: "+u.placeholder):u.setCustomValidity(""),u.reportValidity()};window.form={deactivate:()=>{window.preview.avatar.src="img/muffin-grey.svg",window.preview.adphoto.src="",r.classList.add("ad-form--disabled"),r.querySelectorAll("fieldset").forEach((e=>e.setAttribute("disabled","true"))),r.reset(),_(i.value),f(t,t),u.placeholder=e[l.options[l.selectedIndex].value],l.removeEventListener("change",E),u.removeEventListener("input",E),s.removeEventListener("input",h),i.removeEventListener("change",w),r.removeEventListener("submit",v),c.addEventListener("click",y)},activate:()=>{f(t,84),r.classList.remove("ad-form--disabled"),r.querySelectorAll("fieldset").forEach((e=>e.removeAttribute("disabled","true"))),_(i.value),l.addEventListener("change",E),u.addEventListener("input",E),s.addEventListener("input",h),i.addEventListener("change",w),p.addEventListener("change",(()=>{m.value=p.value})),m.addEventListener("change",(()=>{p.value=m.value})),r.addEventListener("submit",v),c.addEventListener("click",y)},setActivatedPinAddress:()=>{f(t,84)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=()=>{window.map.deactivate(),window.form.deactivate()};o();const n=()=>{window.map.activate(),window.form.activate()};e.addEventListener("keydown",(e=>{"Enter"===e.key&&t.classList.contains("map--faded")&&n()})),e.addEventListener("mousedown",(e=>{0===e.button&&t.classList.contains("map--faded")&&n(),window.movepin.dragNDropMainPin("mousedown"),e.preventDefault()})),window.main={deactivatePage:o,activatePage:n}})()})();