(()=>{"use strict";(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),o=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=o.querySelector(".error__button"),n=e=>{"Escape"===e.key&&(e.preventDefault(),a())},a=()=>{(e.contains(t)?t:o).remove(),document.removeEventListener("click",a),document.removeEventListener("keydown",n)};window.utils={openErrorOnLoad:e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},openSuccessMessage:()=>{window.main.deactivatePage(),e.appendChild(t),document.addEventListener("click",a),document.addEventListener("keydown",n)},openErrorOnUpload:()=>{e.appendChild(o),r.addEventListener("click",a),document.addEventListener("click",a),document.addEventListener("keydown",n)},onPopupEscPress:n}})(),(()=>{const e="POST",t="GET",o=new XMLHttpRequest,r=new XMLHttpRequest,n=(e,t,o)=>{o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t(`Статус ответа: ${o.status} ${o.statusText}`)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t(`Запрос не успел выполниться за ${o.timeout} мс`)})),o.timeout=3e3};window.backend={send:(t,r,a)=>{o.open(e,"https://21.javascript.pages.academy/keksobooking"),n(r,a,o),o.send(t)},load:(e,o)=>{r.open(t,"https://21.javascript.pages.academy/keksobooking/data"),n(e,o,r),r.send()}}})(),window.backend.load((e=>{window.data=e.filter((e=>e.offer))}),window.utils.openErrorOnLoad),window.debounce=(e,...t)=>{let o=null;return()=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e.apply(null,...t)}),500)}},(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("#housing-type"),o=e.querySelector("#housing-price"),r=e.querySelector("#housing-rooms"),n=e.querySelector("#housing-guests"),a=e.querySelectorAll(".map__checkbox"),i=()=>[...e.querySelectorAll(".map__checkbox:checked")].map((e=>e.value)),d=[e=>t.selectedIndex?e.offer.type===t.value:e,e=>{switch(o.selectedIndex){case 1:return e.offer.price<5e4&&e.offer.price>1e4;case 2:return e.offer.price<1e4;case 3:return e.offer.price>5e4;default:return e}},e=>r.selectedIndex?e.offer.rooms===Number(r.value):e,e=>n.selectedIndex?e.offer.guests===Number(n.value):e,e=>i().length?i().every((t=>e.offer.features.includes(t))):e],c=()=>d.reduce(((e,t)=>e.filter(t)),window.data),s=window.debounce((()=>{window.pin.remove(),window.map.closePopupCard(),window.pin.render(c())}));window.filter={data:c,activate:()=>{t.addEventListener("change",s),o.addEventListener("change",s),r.addEventListener("change",s),n.addEventListener("change",s),a.forEach((e=>e.addEventListener("change",s)))},deactivate:()=>{t.removeEventListener("change",s),o.removeEventListener("change",s),r.removeEventListener("change",s),n.removeEventListener("change",s),a.forEach((e=>e.removeEventListener("change",s)))}}})(),(()=>{const e=document.querySelector(".ad-form__field input[type=file]"),t=document.querySelector(".ad-form-header__preview img"),o=document.querySelector(".ad-form__upload input[type=file]"),r=document.querySelector(".ad-form__photo"),n=document.createElement("img");n.style.maxWidth="100%",n.style.height="auto";const a=(e,t)=>{const o=new FileReader,r=e.files[0];o.addEventListener("load",(()=>{t.src=o.result})),o.readAsDataURL(r)};e.addEventListener("change",(()=>{a(e,t)})),r.appendChild(n),o.addEventListener("change",(()=>{a(o,n)})),window.preview={avatar:t,adphoto:n}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),o=e=>{"Escape"===e.key&&(e.preventDefault(),n())},r=()=>{const t=e.querySelector(".popup");t&&t.remove()},n=()=>{r(),window.pin.deactive(),document.removeEventListener("keydown",o)};window.map={openPopupCard:e=>{r(),window.card.render(e),document.addEventListener("keydown",o)},closePopupCard:n,deactivate:()=>{e.classList.add("map--faded"),window.filter.deactivate(),t.reset(),t.classList.add("map__filters--disabled"),[...t.children].forEach((e=>e.setAttribute("disabled","true"))),window.pin.remove(),window.movepin.setMainPinStartCoords(),document.querySelector(".popup")&&n()},activate:()=>{e.classList.remove("map--faded"),window.pin.render(window.data),window.filter.activate()}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t={x:e.style.top,y:e.style.left};window.movepin={dragNDropMainPin:t=>{let o={x:t.clientX,y:t.clientY};const r=t=>{t.preventDefault();const r=o.x-t.clientX,n=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const a=(e,t,o)=>e>t?t+"px":e<o?o+"px":e+"px";e.style.top=a(e.offsetTop-n,546,46),e.style.left=a(e.offsetLeft-r,1169,-31),window.form.setActivatedPinAddress()},n=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",n)},setMainPinStartCoords:()=>{e.style.top=t.x,e.style.left=t.y},mainPin:e}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.querySelector(".map__filters"),r=()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.classList.remove("map__pin--active")))},n=e=>{const o=t.cloneNode(!0),r=o.querySelector("img");return o.style.cssText=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,r.src=e.author.avatar,r.alt=e.offer.title,o};window.pin={render:t=>{const a=document.createDocumentFragment();for(let e=0;e<t.length&&e<5;e++)a.appendChild(n(t[e]));e.appendChild(a),o.classList.remove("map__filters--disabled"),[...o.children].forEach((e=>e.removeAttribute("disabled","true"))),e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach(((e,t)=>e.addEventListener("click",(()=>{r(),e.classList.add("map__pin--active"),window.map.openPopupCard(t)}))))},remove:()=>{e.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},deactive:r}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector(".map"),o=document.querySelector("#card").content.querySelector(".map__card");window.card={render:r=>{const n=(t=>{const r=o.cloneNode(!0),n=r.querySelector(".popup__avatar"),a=r.querySelector(".popup__title"),i=r.querySelector(".popup__text--address"),d=r.querySelector(".popup__text--price"),c=r.querySelector(".popup__type"),s=r.querySelector(".popup__text--capacity"),l=r.querySelector(".popup__text--time"),u=r.querySelectorAll(".popup__feature"),p=r.querySelector(".popup__features"),m=r.querySelector(".popup__description");n.src=t.author.avatar?t.author.avatar:n.remove(),a.textContent=t.offer.title?t.offer.title:a.remove(),i.textContent=t.offer.address?t.offer.address:i.remove(),d.textContent=t.offer.price?t.offer.price+"₽/ночь":d.remove(),c.textContent=t.offer.type?e[t.offer.type]:c.remove(),s.textContent=void 0!==(t.offer.rooms&&t.offer.guests)?`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`:s.remove(),l.textContent=t.offer.checkin&&t.offer.checkout?`Заезд после ${t.offer.checkin}, выезд до ${t.offer.checkout}`:l.remove(),t.offer.features.length?[...u].filter((e=>!t.offer.features.some((t=>e.className.includes("--"+t))))).forEach((e=>p.removeChild(e))):p.remove(),m.textContent=t.offer.description?t.offer.description:m.remove();const v=r.querySelector(".popup__photos"),f=v.querySelector("img"),y=t.offer.photos;if(v.innerHTML="",y.length)for(let e=0;e<y.length;e++){const t=f.cloneNode(!0);t.src=y[e],v.appendChild(t)}else v.remove();return r})(window.filter.data()[r]);t.insertBefore(n,t.lastElementChild),n.querySelector(".popup__close").addEventListener("click",window.map.closePopupCard)}}})(),(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t=31,o={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]},r=window.movepin.mainPin,n=document.querySelector(".ad-form"),a=n.querySelector("#address"),i=n.querySelector("#capacity"),d=n.querySelector("#room_number"),c=n.querySelector(".ad-form__reset"),s=n.querySelector("#title"),l=n.querySelector("#type"),u=n.querySelector("#price"),p=n.querySelector("#timein"),m=n.querySelector("#timeout"),v=e=>{e.preventDefault(),window.backend.send(new FormData(n),window.utils.openSuccessMessage,window.utils.openErrorOnUpload)},f=()=>{window.main.deactivatePage()},y=e=>{h(e.target.value)},w=(e,t)=>{a.value=parseInt(r.style.left,10)+e+", "+(parseInt(r.style.top,10)+t)};a.setAttribute("readonly",!0),w(t,t);const h=e=>{[...i.options].forEach((t=>{t.disabled=!o[e].includes(t.value)})),i.value=e>3?0:e},_=()=>{const e=s.value.length;e<30?s.setCustomValidity("Еще "+(30-e)+" симв."):e>100?s.setCustomValidity("Удалите лишние "+(e-100)+" симв."):s.setCustomValidity(""),s.reportValidity()},E=()=>{u.placeholder=e[l.value],parseInt(u.value,10)<parseInt(u.placeholder,10)?u.setCustomValidity("Минимальная цена для данного типа жилья: "+u.placeholder):u.setCustomValidity(""),u.reportValidity()};window.form={deactivate:()=>{window.preview.avatar.src="img/muffin-grey.svg",window.preview.adphoto.src="",n.classList.add("ad-form--disabled"),n.querySelectorAll("fieldset").forEach((e=>e.setAttribute("disabled","true"))),n.reset(),h(d.value),w(t,t),l.removeEventListener("change",E),u.removeEventListener("input",E),s.removeEventListener("input",_),d.removeEventListener("change",y),n.removeEventListener("submit",v),c.addEventListener("click",f)},activate:()=>{w(t,84),n.classList.remove("ad-form--disabled"),n.querySelectorAll("fieldset").forEach((e=>e.removeAttribute("disabled","true"))),h(d.value),l.addEventListener("change",E),u.addEventListener("input",E),s.addEventListener("input",_),d.addEventListener("change",y),p.addEventListener("change",(()=>{m.value=p.value})),m.addEventListener("change",(()=>{p.value=m.value})),n.addEventListener("submit",v),c.addEventListener("click",f)},setActivatedPinAddress:()=>{w(t,84)}}})(),(()=>{const e=document.querySelector(".map__pin--main"),t=document.querySelector(".map"),o=()=>{window.map.deactivate(),window.form.deactivate()};o();const r=()=>{window.map.activate(),window.form.activate()};e.addEventListener("keydown",(e=>{"Enter"===e.key&&t.classList.contains("map--faded")&&r()})),e.addEventListener("mousedown",(e=>{0===e.button&&t.classList.contains("map--faded")&&r(),window.movepin.dragNDropMainPin("mousedown"),e.preventDefault()})),window.main={deactivatePage:o,activatePage:r}})()})();